name: Build Windows Installer

on:
  workflow_dispatch:
    inputs:
      gguf_url:
        description: "Direct download URL for GGUF model (.gguf)"
        required: true
      sherpa_zip_url:
        description: "Direct download URL for sherpa-onnx model zip"
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install gdown
          python -m pip install pyinstaller

      - name: Download models
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path models\llm | Out-Null
          New-Item -ItemType Directory -Force -Path models\sherpa-onnx | Out-Null

          $gguf = "${{ inputs.gguf_url }}"
          $sherpaZip = "${{ inputs.sherpa_zip_url }}"

          Write-Host "Downloading GGUF via gdown..."
          python -m gdown --fuzzy "$gguf" -O models\llm\model.gguf

          Write-Host "Downloading sherpa-onnx zip via gdown..."
          python -m gdown --fuzzy "$sherpaZip" -O models\sherpa-onnx.zip
          Expand-Archive -Path models\sherpa-onnx.zip -DestinationPath models\sherpa-onnx -Force

      - name: Prepare desktop assets
        run: |
          python scripts\prepare_desktop_assets.py

      - name: Build backend
        run: |
          python scripts\build_backend.py

      - name: Build Windows installer
        run: |
          cd desktop
          npm install
          npm run build:win

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: desktop\dist\AI Meeting Assistant Setup *.exe
